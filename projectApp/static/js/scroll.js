// const translations = {
//     "主頁": { en: "Home", zh: "主頁" },
//     "公告": { en: "Announcement", zh: "公告" },
//     "預約系統": { en: "Reservation System", zh: "預約系統" },
//     "注意事項": { en: "Notations", zh: "注意事項" },
//     "常見問題": { en: "F&Q", zh: "常見問題" },
//     "功能": { en: "Function", zh: "功能" },
//     "個人": { en: "Profile", zh: "個人" },
//     "更改密碼": { en: "Change Password", zh: "更改密碼" },
//     "登出": { en: "Logout", zh: "登出" },
//     "歡迎": { en: "Welcome,", zh: "歡迎，" },
//     "歡迎來到琴房預約系統": { en: "Welcome to the Piano Room Reservation System", zh: "歡迎來到琴房預約系統" },
//     "最新 Facebook 貼文": { en: "Latest Facebook Post", zh: "最新 Facebook 貼文" },
//     "查看更多": { en: "View More", zh: "查看更多" },
//     "琴房報修": { en: "Piano Room Report Repair", zh: "琴房報修" },
//     "大琴房" : { en: "Large Piano room", zh: "大琴房"},
//     "Large Piano room" : { en: "Large Piano room", zh: "大琴房"},
//     "中琴房" : { en: "Medium Piano room", zh: "中琴房"},
//     "Medium Piano room" : { en: "Medium Piano room", zh: "中琴房"},
//     "小琴房" : { en: "Small Piano room", zh: "小琴房"},
//     "Small Piano room" : { en: "Small Piano room", zh: "小琴房"},
//     "社窩" : { en: "Club room", zh: "社窩"},
//     "Club room" : { en: "Club room", zh: "社窩"},
//     "若您是第一次使用，請閱讀以下注意事項": { en: "If this is your first time, please read the following precautions", zh: "若您是第一次使用，請閱讀以下注意事項" },
//     "中央鋼琴社預約系統": { en: "National Central University Piano Society Reservation System", zh: "中央鋼琴社預約系統" },
//     "關於預約系統": { en: "About the Reservation System", zh: "關於預約系統" },
//     "1.預約方式為即按即預約。": { en: "1.The reservation method is instant reservation.", zh: "1.預約方式為即按即預約。" },
//     "2.每次預約為半個小時": { en: "2.Each reservation is for half an hour.", zh: "2.每次預約為半個小時。" },
//     "3.每人每周不得預約超過七小時，違規者系統將自動取消。": { en: "3.Each person is not allowed to reserve more than seven hours per week. Violators will be automatically canceled by the system.", zh: "3.每人每周不得預約超過七小時，違規者系統將自動取消。" },
//     "4.每周日00:00才會開放當周可預約的時段" : { en: "4.The available time slots for the week will be opened at 00:00 on Sunday.", zh: "4.每周日00:00才會開放當周可預約的時段。" },
//     "5.為達使用琴房效率最大化，預約後若無法到場請記得取消預約": { en: "5.In order to maximize the efficiency of using the piano room, please remember to cancel the reservation if you cannot attend after the reservation.", zh: "5.為達使用琴房效率最大化，預約後若無法到場請記得取消預約。" },

//     "關於琴房": { en: "About the Piano Room", zh: "關於琴房" },
//     "1.開完琴房後鑰匙請記得掛回社窩，並鎖上門。": { en: "1.After unlocking the piano room, please remember to hang the key back in the club room and lock the door.", zh: "1.開完琴房後鑰匙請記得掛回社窩，並鎖上門。" },
//     "2.離開琴房時請記得關燈、鎖門。": { en: "2.When leaving the piano room, please remember to turn off the lights and lock the door.", zh: "2.離開琴房時請記得關燈、鎖門。" },
//     "3.有任何問題或建議請聯絡網管。": { en: "3.If you have any questions or suggestions, please contact the network administrator. Email: yanchaun0970@gmail.com", zh: "3.有任何問題或建議請聯絡網管。 Email: yanchaun0970@gmail.com" },

//     "Q1:如何預約琴房？": { en: "Q1: How to reserve a piano room?", zh: "Q1:如何預約琴房？" },
//     "A1:請至預約系統頁面，選擇您想預約的琴房，選擇您想要的日期，點擊想要的時間即可預約。" : { en: "A1: Please go to the reservation system page, select the piano room you want to reserve, select the date you want, and click the time you want to reserve.", zh: "A1:請至預約系統頁面，選擇您想預約的琴房，選擇您想要的日期，點擊想要的時間即可預約。" },
//     "Q2:如何取消預約？" : { en: "Q2: How to cancel a reservation?", zh: "Q2:如何取消預約？" },
//     "A2:請至預約系統頁面，選擇您預約過的日期，選擇您想取消的預約，點擊取消即可。" : { en: "A2: Please go to the reservation system page, select the date you have reserved, select the reservation you want to cancel, and click cancel.", zh: "A2:請至預約系統頁面，選擇您預約過的日期，選擇您想取消的預約，點擊取消即可。" },
//     "Q3:別人會看的到我的預約嗎？" : { en: "Q3: Can others see my reservation?", zh: "Q3:別人會看的到我的預約嗎？" },
//     "A3:會，為達交流最大化，此新系統特意新增其功能。" : { en: "A3: Yes, in order to maximize communication, this new system has added this function.", zh: "A3:會，為達交流最大化，此新系統特意新增其功能。" },
//     "Q4:如何修改密碼？" : { en: "Q4: How to change password?", zh: "Q4:如何修改密碼？" },
//     "A4:請點擊「個人」，點擊「更改密碼」。" : { en: "A4: Please click 'Profile', click 'Change Password'.", zh: "A4:請點擊「個人」，點擊「更改密碼」。" },
//     "Q5:如何查看自己的預約？" : { en: "Q5: How to check my reservation?", zh: "Q5:如何查看自己的預約？" },
//     "A5:請點擊「個人」即可看見預約歷史" : { en: "A5: Please click 'Profile' to see the reservation history.", zh: "A5:請點擊「個人」即可看見預約歷。" },
    
// };

// function initializeTranslations() {
//     const selectedLanguage = document.getElementById('languages').value || 'zh'; // 預設為中文
//     document.querySelectorAll('[data-translate]').forEach(element => {
//         const key = element.getAttribute('data-translate');
//         if (translations[key] && translations[key][selectedLanguage]) {
//             element.textContent = translations[key][selectedLanguage];
//         }
//     });
// }

// // 在頁面載入時初始化
// document.addEventListener('DOMContentLoaded', initializeTranslations);

// // 切換語言功能
// document.getElementById('languages').addEventListener('change', function () {
//     const selectedLanguage = this.value;
//     document.querySelectorAll('[data-translate]').forEach(element => {
//         const key = element.getAttribute('data-translate');
//         if (translations[key] && translations[key][selectedLanguage]) {
//             element.textContent = translations[key][selectedLanguage];
//         }
//     });
// });

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
function openLoadingDialog() {
    const dialog = document.getElementById('LoadingDialog');
    dialog.showModal();
}
function closeLoadingDialog() {
    const dialog = document.getElementById('LoadingDialog');
    dialog.close();
}

function openDialog(event) {
    const button = event.currentTarget;
    const date = button.getAttribute('data-date');
    // 翻譯房間類型
    let roomType = button.closest('.button-container').previousElementSibling.textContent.trim();
    // if (translations[roomType] && translations[roomType]['zh']) {
    //     roomType = translations[roomType]['zh']; // 確保傳遞中文名稱到後端
    // }
    // console.log(roomType);
    const dialog = document.getElementById("myDialog");
    dialog.setAttribute('data-date', date); // 設定對話框屬性 date

    openLoadingDialog(); // 顯示加載對話框

    // 獲取事件並更新對話框
    // console.log('📅 獲取日期:', date, roomType, currentUsername);
    fetch(`/get-calendar-events/?date=${date}&roomType=${encodeURIComponent(roomType)}&user_name=${currentUsername}`)
        .then(response => response.json())
        .then(async data => {
            // console.log(data);
            if (data.error) {
                console.error(data.error);
                dialog.innerHTML = `<h2>加載失敗，請重試。</h2>`;
                return;
            }
            // **獲取目前時間**
            const currentTime = new Date();
            const currentMinutes = currentTime.getHours() * 60 + currentTime.getMinutes(); // 轉換為總分鐘數

            let activeUser = null; // 記錄當前正在使用房間的使用者

            // **檢查有無正在使用的預約**
            data.events.forEach(event => {
                const eventStart = new Date(event.start);
                const eventEnd = new Date(event.end);
                const startMinutes = eventStart.getHours() * 60 + eventStart.getMinutes();
                const endMinutes = eventEnd.getHours() * 60 + eventEnd.getMinutes();

                if (currentMinutes >= startMinutes && currentMinutes < endMinutes) {
                    // **如果當前時間在該事件的範圍內，記錄使用者名稱**
                    const summary = event.summary || '';
                    const nameMatch = summary.match(/^(.*?) 預約/);
                    activeUser = nameMatch ? nameMatch[1] : '未知';
                }
            });
            // console.log('👤 當前使用者:', activeUser);

            const timeSlots = await generateTimeSlots(data.events, date, roomType, currentUsername);
            closeLoadingDialog(); // 關閉加載對話框
            // 檢查當前時間段是否被預約
            const activeUserSection = activeUser
            ? `<h3>現在<i>${activeUser}</i> 正在使用中</h3>`
            : ''; // 若無則不顯示
            
            // **更新對話框內容**
            dialog.innerHTML = `
                <h2>日期：${date}<br>${roomType}</h2>
                ${activeUserSection} <!-- 這裡顯示正在使用中的訊息 -->
                <div class="time-slots">
                    ${timeSlots}
                </div>
                <button onclick="closeDialog()">關閉</button>
            `;

            dialog.showModal();
            dialog.scrollTop = 0; // 滾動到頂部
        })
        .catch(error => {
            console.error('Error fetching events:', error);
            dialog.innerHTML = `<h2>發生錯誤，請稍後再試。</h2>`;
        });
}


async function generateTimeSlots(events, targetDate, roomType, userName) {
    const slots = [];
    const timeStart = new Date(targetDate);
    const timeEnd = new Date(targetDate);
    let starttime = 8;
    let endtime = 22;
    const response = await fetch('/get-time-range/')
    const timeRange = await response.json();
    if (timeRange.starttime) {
        starttime = timeRange.starttime;
    }
    if (timeRange.endtime) {
        endtime = timeRange.endtime;
    }
    timeStart.setHours(starttime, 0, 0, 0);
    timeEnd.setHours(endtime, 0, 0, 0);

    const currentDateTime = new Date(); // 獲取當前日期時間

    // **等待 `ShowReserveName` 設定完成**
    let ShowReserveName = false;
    try {
        const response = await fetch(`/get-show-reserve-name`);
        const data = await response.json();
        ShowReserveName = data.ShowReserveName === 'yes';
    } catch (error) {
        console.error("❌ 獲取 ShowReserveName 失敗:", error);
    }
    // console.log(currentDateTime);
    for (let time = new Date(timeStart); time <= timeEnd; time.setMinutes(time.getMinutes() + 30)) {
        // 檢查時間是否已過
        // console.log(time);
        // console.log('time < currentDateTime.getMinutes()', time < currentDateTime.getMinutes());
        if (time < currentDateTime) {   
            // console.log('⏰ 跳過已過去的時間:', time); 
            continue; // 跳過已過去的時間
        }
        const timeString = time.toTimeString().split(' ')[0].slice(0, 5); // 獲取本地時間 HH:mm 格式

        // 檢查當前時間段是否被預約
        const occupiedEvent = events.find(event => {
            const eventStart = new Date(event.start).getTime();
            const eventEnd = new Date(event.end).getTime();
            return time.getTime() >= eventStart && time.getTime() < eventEnd;
        });

        let occupiedMessage = '';
        let cancelBtn = '';

        if (occupiedEvent) {
            const summary = occupiedEvent.summary || '';
            const nameMatch = summary.match(/^(.*?) 預約/); // 匹配 "XXX 預約"
            const reserverName = nameMatch ? nameMatch[1] : '未知';

            occupiedMessage = `(已被<i>${reserverName}</i> 預約)`; // 顯示預約者姓名

            if (reserverName === userName) {
                cancelBtn = `
                    <a class="cancel-button" onclick="cancelReservationByTime('${targetDate}', '${timeString}', '${roomType}', '${userName}')">
                        取消
                    </a>
                `;
            }
        }

        // **根據 ShowReserveName 決定是否顯示預約者姓名**
        slots.push(`
            <div class="time-slot-container">
                <a class="time-slot ${occupiedEvent ? 'occupied' : 'available'}" 
                    onclick="handleTimeSlotClick('${targetDate}', '${timeString}', '${userName}', '${roomType}', ${!!occupiedEvent})">
                    ${timeString} ${ShowReserveName && occupiedEvent ? occupiedMessage : ''}
                </a>
                ${cancelBtn}
            </div>
        `);
    }

    return slots.join(''); // 返回 HTML 字符串
}


let isProcessing = false; // 全局變量，用於跟蹤是否正在處理請求

function handleTimeSlotClick(date, time, userName, roomType, isOccupied) {
    if (isOccupied) {
        alert('該時間段已被預約！');
        return;
    }

    // 如果正在處理，阻止新的點擊事件
    if (isProcessing) {
        console.warn("正在處理請求，請稍後再試...");
        return;
    }

    // 標記正在處理中
    isProcessing = true;

    // 禁用所有時間段按鈕
    const timeSlotButtons = document.querySelectorAll('.time-slot');
    timeSlotButtons.forEach(button => {
        button.setAttribute('disabled', true);
        button.style.cursor = 'not-allowed'; // 更新游標樣式
        button.style.opacity = '0.5'; // 顯示禁用狀態
    });

    const duration = 30; // 預設使用時間為 30 分鐘
    const payload = {
        date: date,
        start_time: time,
        user_name: userName,
        room_type: roomType,
        duration: duration
    };

    console.log("發送的參數:", payload);

    fetch('/create-calendar-event/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken // 添加 CSRF Token
        },
        body: JSON.stringify(payload),
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 成功後更新時間段
                fetch(`/get-calendar-events/?date=${date}&roomType=${encodeURIComponent(roomType)}&user_name=${userName}`)
                    .then(response => response.json())
                    .then(async data => {
                        if (data.error) {
                            console.error("更新時間表失敗:", data.error);
                            return;
                        }

                        const updatedTimeSlots = await generateTimeSlots(data.events, date, roomType, userName);
                        const dialog = document.getElementById("myDialog");
                        dialog.querySelector('.time-slots').innerHTML = updatedTimeSlots;
                    })
                    .catch(error => {
                        console.error('更新時間表時發生錯誤:', error);
                    });
            } else {
                alert('預約失敗：' + data.error);
            }
        })
        .catch(error => {
            console.error('發生錯誤:', error);
            alert('預約失敗，請稍後再試。');
        })
        .finally(() => {
            // 恢復按鈕的可用性
            isProcessing = false; // 清除處理狀態
            timeSlotButtons.forEach(button => {
                button.removeAttribute('disabled');
                button.style.cursor = 'pointer';
                button.style.opacity = '1';
            });
        });
}


function cancelReservationByTime(date, time, roomType, userName) {
  if (!confirm('確定要取消這個預約嗎？')) {
      return;
  }
  // 如果正在處理，阻止新的點擊事件
  if (isProcessing) {
      console.warn("正在處理請求，請稍後再試...");
      return;
  }

  // 標記正在處理中
  isProcessing = true;

  // 禁用所有時間段按鈕
  const timeSlotButtons = document.querySelectorAll('.time-slot');
  timeSlotButtons.forEach(button => {
      button.setAttribute('disabled', true);
      button.style.cursor = 'not-allowed'; // 更新游標樣式
      button.style.opacity = '0.5'; // 顯示禁用狀態
  });
  const cancelBtn = document.querySelectorAll('.cancel-button');
  cancelBtn.forEach(button => {
      button.setAttribute('disabled', true);
      button.style.cursor = 'not-allowed'; // 更新游標樣式
      button.style.opacity = '0.5'; // 顯示禁用狀態
 });
  const dialog = document.getElementById("myDialog");
  const updatedDate = dialog.getAttribute('data-date'); // 確保從對話框屬性獲取日期

  if (!updatedDate) {
      console.error('無法獲取日期，請檢查對話框屬性');
      return;
  }

  
  const url = `/cancel-calendar-event-by-time/?date=${encodeURIComponent(date)}&start_time=${encodeURIComponent(time)}&roomType=${encodeURIComponent(roomType)}&user_name=${encodeURIComponent(userName)}`;

  fetch(url, {
      method: 'GET',
      headers: {
          'X-CSRFToken': csrfToken // 添加 CSRF Token
      },
  })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              // alert('預約已取消！');
              // 更新時間段
              fetch(`/get-calendar-events/?date=${updatedDate}&roomType=${encodeURIComponent(roomType)}&user_name=${userName}`)
                  .then(response => response.json())
                  .then(async data => {
                      if (data.error) {
                          console.error("更新時間表失敗:", data.error);
                          return;
                      }
                      const updatedTimeSlots = await generateTimeSlots(data.events, date, roomType, userName);
                      dialog.querySelector('.time-slots').innerHTML = updatedTimeSlots;
                  });
          } else {
              alert('取消失敗：' + data.error);
          }
      })
      .catch(error => {
          console.error('取消預約時發生錯誤:', error);
          alert('取消失敗，請稍後再試。');
      })
      .finally(() => {
        // 恢復所有時間段按鈕的可用性
        isProcessing = false; // 清除處理狀態
        timeSlotButtons.forEach(button => {
            button.removeAttribute('disabled');
            button.style.cursor = 'pointer';
            button.style.opacity = '1';
        });
        cancelBtn.forEach(button => {
            button.removeAttribute('disabled');
            button.style.cursor = 'pointer';
            button.style.opacity = '1';
        });
    });
}




function closeDialog() {
  const dialog = document.getElementById("myDialog");
  dialog.close();
}
// 新增點擊灰色背景關閉對話框的功能
document.addEventListener('click', function (event) {
  const dialog = document.getElementById("myDialog");

  // 確保對話框是打開的
  if (dialog.open) {
      // 判斷點擊是否發生在對話框外部
      const rect = dialog.getBoundingClientRect();
      const isInDialog =
          event.clientX >= rect.left &&
          event.clientX <= rect.right &&
          event.clientY >= rect.top &&
          event.clientY <= rect.bottom;

      if (!isInDialog) {
          dialog.close(); // 關閉對話框
      }
  }
});

// 新增點擊灰色背景關閉對話框的功能
document.addEventListener('click', function (event) {
  const dialog = document.getElementById("LoadingDialog");

  // 確保對話框是打開的
  if (dialog.open) {
      // 判斷點擊是否發生在對話框外部
      const rect = dialog.getBoundingClientRect();
      const isInDialog =
          event.clientX >= rect.left &&
          event.clientX <= rect.right &&
          event.clientY >= rect.top &&
          event.clientY <= rect.bottom;

      if (!isInDialog) {
          dialog.close(); // 關閉對話框
      }
  }
});

function calculateWeekDates() {
  const today = new Date(); // 當前日期
  const dayOfWeek = today.getDay(); // 今天是星期幾 (0: 星期日, 1: 星期一, ...)
  const startOfWeek = new Date(today); // 複製當前日期

  // const offset = (dayOfWeek + 1) % 7; // 從今天向前偏移到最近的星期六
  // startOfWeek.setDate(today.getDate() - offset); // 設定為當週星期六
  startOfWeek.setDate(today.getDate() - dayOfWeek); // 設定為當週星期日

  // 生成當週 7 天的日期
  const weekDates = [];
  for (let i = 0; i < 7; i++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + i); // 增加 i 天
    weekDates.push(
      new Date(date.getFullYear(), date.getMonth(), date.getDate()) // 確保是本地時間
    );
  }
  return weekDates;
}


// 格式化日期為 "月/日 星期X"
function formatDate(date) {
  const options = { month: 'numeric', day: 'numeric' }; // 格式：月/日
  const weekdayNames = ['日', '一', '二', '三', '四', '五', '六']; // 星期名稱
  const formattedDate = date.toLocaleDateString('zh-TW', options);
  const weekday = weekdayNames[date.getDay()];
  return `${formattedDate} 星期${weekday}`;
}



async function fetchLatestPost() {
    try {
        const response = await fetch('/get-latest-post/');
        const posts_data = await response.json(); // 獲取貼文列表
        const posts = posts_data[0]

        const postContainer = document.getElementById('post-content');
        postContainer.innerHTML = ""; // 清空現有內容

        posts.forEach((post) => {
            const postElement = document.createElement("div");
            postElement.classList.add("fb-post");
            const title = post.message.split('\n')[0];
            let postcontent = post.message.replace(title+"\n\n", '');
            postElement.innerHTML = `
                <h3 class="post-title">${title}</h3>
                <p class="white-space-pre">${postcontent}</p>
                ${post.image ? `<img src="${post.image}" alt="Facebook Image" class="Post_Image">` : ''}
                <br>
                <a href="${post.link}" target="_blank" class="post-link" data-translate="查看更多">查看更多</a>
                <hr>
            `;

            postContainer.appendChild(postElement); // 追加貼文
        });

    } catch (error) {
        console.error('❌ 無法獲取最新貼文：', error);
    }
}
// function updateReservationButtons() {
//     const weekDates = calculateWeekDates(); // 獲取當週日期
//     const today = new Date(); // 獲取今天日期
//     today.setHours(0, 0, 0, 0); // 將今天的時間設為 0 點，便於比較
  
//     // 找到每個琴房區塊中的按鈕
//     const roomContainers = document.querySelectorAll('.button-container');
//     roomContainers.forEach((container) => {
//       const buttons = container.querySelectorAll('.reservation-btn');
//       buttons.forEach((button, index) => {
//         if (index < weekDates.length) {
//           const buttonDate = weekDates[index];
//           button.innerText = formatDate(buttonDate); // 更新按鈕文字
  
//           // 使用本地日期作為 data-date
//           const localDate = `${buttonDate.getFullYear()}-${(buttonDate.getMonth() + 1)
//             .toString()
//             .padStart(2, '0')}-${buttonDate.getDate().toString().padStart(2, '0')}`;
//           button.setAttribute('data-date', localDate); // 設定 data-date 屬性
  
//           // 禁用過去的日期按鈕
//           if (buttonDate < today) {
//             button.style.backgroundColor = 'gray'; // 設定灰色背景
//             button.style.cursor = 'not-allowed'; // 改變游標為不可用樣式
//             button.onclick = null; // 禁止點擊事件
//           } else {
//             button.style.backgroundColor = ''; // 還原按鈕背景
//             button.style.cursor = 'pointer'; // 還原游標樣式
//             button.onclick = (event) => openDialog(event); // 綁定點擊事件
//           }
//         }
//       });
//     });
// }


async function generateRoomButtons() {
    try {
        const response = await fetch('/get-room-type/');
        if (!response.ok) {
            throw new Error(`伺服器錯誤: ${response.status}`);
        }
        
        const roomTypeData = await response.json();
        if (!roomTypeData.RoomName) {
            throw new Error('回應格式錯誤，缺少 RoomName');
        }

        const roomTypes = roomTypeData.RoomName; // 取得房間類型陣列
        // console.log('🏠 獲取房間類型成功:', roomTypes);

        const reservationSection = document.querySelector('#reservation');
        const existingButtons = document.querySelector('.All-room-button');
        if (existingButtons) existingButtons.remove();

        const allRoomDiv = document.createElement("div");
        allRoomDiv.classList.add("All-room-button");

        const weekDates = calculateWeekDates(); // 取得當週日期
        const currentDate = new Date();
        currentDate.setHours(0, 0, 0, 0); // 確保只比較日期，不受時間影響

        roomTypes.forEach((room) => {
            // 創建房間區塊
            const roomDiv = document.createElement("div");
            roomDiv.classList.add("room-section");

            // 添加房間標題
            const title = document.createElement("h3");
            title.textContent = room;
            title.setAttribute("data-translate", room);
            roomDiv.appendChild(title);

            // 創建按鈕容器
            const buttonContainer = document.createElement("div");
            buttonContainer.classList.add("button-container");

            // 為該房間生成日期按鈕
            weekDates.forEach((date) => {
                const button = document.createElement("button");
                button.classList.add("reservation-btn");
                button.textContent = formatDate(date); // 顯示日期
                // 使用本地日期作為 data-date
                const localDate = `${date.getFullYear()}-${(date.getMonth() + 1)
                    .toString()
                    .padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                button.setAttribute("data-date", localDate);

                // 設定按鈕可用性
                if (date < currentDate) {
                    button.disabled = true;
                    button.style.backgroundColor = 'gray';
                    button.style.cursor = 'not-allowed';
                } else {
                    button.onclick = (event) => openDialog(event);
                }

                buttonContainer.appendChild(button);
            });

            // 加入房間區塊
            roomDiv.appendChild(buttonContainer);
            allRoomDiv.appendChild(roomDiv);
        });

        reservationSection.appendChild(allRoomDiv);
    } catch (error) {
        console.error('❌ 無法獲取房間類型:', error);
    }
}

async function GetSystemname(){
    try {
        const response = await fetch('/get-system-name/');
        const systemName = await response.json();
        // console.log(systemName);
        if (systemName.error) {
            throw new Error(systemName.error);
        }
        const systemNameElement = document.getElementById('System_Name');
        // console.log('🏠 系統名稱:', systemName.SystemName);
        systemNameElement.textContent = systemName.SystemName;
    } catch (error) {
        console.error('❌ 無法獲取系統名稱:', error);
    }
}

async function GetRules(){
    try {
        const response = await fetch('/get-rules/');
        const rules = await response.json();
        // console.log(rules);
        if (rules.error) {
            throw new Error(rules.error);
        }
        const announce_title = rules.announcement_title;
        const announce_content = rules.announcement_content;
        const Q = rules.Q;
        const A = rules.A;
        const notation = rules.notation;
        // console.log('🏠 規則:', Q, A, notation);
        if (notation && Object.keys(notation).length > 0) {
            if (notation.hasOwnProperty('system')) {
                const notationElement = document.getElementById('notations');
                const Bigtitle = document.createElement('h2');
                Bigtitle.textContent = "注意事項";
                notationElement.appendChild(Bigtitle);
                const notationDiv = document.createElement('div');
                const title = document.createElement('h3');
                title.textContent = "關於預約系統：";
                notationDiv.appendChild(title);
                let num = 1;
                notation['system'].forEach((element) => {
                    const p = document.createElement('p');
                    p.textContent = `${num++}. ${element}`;
                    notationDiv.appendChild(p);
                });
                notationElement.appendChild(notationDiv);
            }
            if (notation.hasOwnProperty('room')) {
                const notationElement = document.getElementById('notations');
                const notationDiv = document.createElement('div');
                const title = document.createElement('h3');
                title.textContent = "關於琴房：";
                notationDiv.appendChild(title);
                let num = 1;
                notation['room'].forEach((element) => {
                    const p = document.createElement('p');
                    p.textContent = `${num++}. ${element}`;
                    notationDiv.appendChild(p);
                });
                notationElement.appendChild(notationDiv);
            }
        }
        if (Q && Object.keys(Q).length > 0) {
            const QAElem = document.getElementById('questions');
            const Bigtitle = document.createElement('h2');
            Bigtitle.textContent = "常見問題";
            QAElem.appendChild(Bigtitle);
            for (const [key, value] of Object.entries(Q)) {
                const QDiv = document.createElement('div');
                const Qtitle = document.createElement('h3');
                Qtitle.textContent = `❓Q${parseInt(key)+1}. ${value}`;
                QDiv.appendChild(Qtitle);
                const Ans = document.createElement('p');
                Ans.className = "faq-answer";
                Ans.textContent = A[key];
                QDiv.appendChild(Ans);
                QAElem.appendChild(QDiv);
            }
        }
        if (announce_title && Object.keys(announce_title).length > 0) {
            const announcementElem = document.getElementById('announcement');
            for (const [key, value] of Object.entries(announce_title)) {
                const announcementDiv = document.createElement('div');
                const title = document.createElement('h3');
                title.className = "post-title";
                title.textContent = `${value}`;
                announcementDiv.appendChild(title);
                const content = document.createElement('p');
                content.className = "white-space-pre";
                content.textContent = announce_content[key];
                announcementDiv.appendChild(content);
                announcementElem.appendChild(announcementDiv);
            }
        }
    } catch (error) {
        console.error('❌ 無法獲取規則:', error);
    }
}


// 初始化
document.addEventListener('DOMContentLoaded', async () => {
    // updateReservationButtons();
    try {
        await GetSystemname();
    } catch (error) {
        console.error("❌ 無法獲取最新貼文:", error);
    }
    try {
        await generateRoomButtons();
    } catch (error) {
        console.error("❌ 無法獲取房間類型:", error);
    }
    try {
        await GetRules();
    } catch (error) {    
        console.error("❌ 無法獲取規則:", error);
    }
    fetchLatestPost();
 });
